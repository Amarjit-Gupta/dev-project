import { useState } from "react";
import axios from "axios";

import FormStep1 from "./steps/FormStep1";
import FormStep2 from "./steps/FormStep2";
import FormStep3 from "./steps/FormStep3";
import FormStep4 from "./steps/FormStep4";
import FormStep5 from "./steps/FormStep5";
import FormStep6 from "./steps/FormStep6";
import ReviewStep from "./steps/ReviewStep";
import StepIndicator from "./steps/StepIndicator";

const totalSteps = 7;

const MultiStepForm = () => {
  const [formStep, setFormStep] = useState(1);
  const [error, setError] = useState(false);

  // ðŸ”‘ Draft ID
  const [draftId, setDraftId] = useState(null);

  // ---------------- STEP STATES ----------------
  const [reportTitle, setReportTitle] = useState("");
  const [subTitle, setSubTitle] = useState("");
  const [industry, setIndustry] = useState("");
  const [subIndustry, setSubIndustry] = useState("");
  const [regions, setRegions] = useState([]);
  const [country, setCountry] = useState([]);
  const [reportType, setReportType] = useState("");
  const [publishDate, setPublishDate] = useState("");
  const [coveragePeriodFrom, setCoveragePeriodFrom] = useState("");
  const [coveragePeriodTo, setCoveragePeriodTo] = useState("");

  const [reportCovers, setReportCovers] = useState([]);
  const [reportSupports, setReportSupports] = useState([]);

  const [availableReports, setAvailableReports] = useState("");
  const [uploadedFile, setUploadedFile] = useState(null);
  const [samplePDF, setSamplePDF] = useState(null);
  const [image, setImage] = useState(null);
  const [charts, setCharts] = useState(null);

  const [sectionName, setSectionName] = useState("");
  const [sectionGroup, setSectionGroup] = useState("");
  const [shortDescription, setShortDescription] = useState("");
  const [previewAvailable, setPreviewAvailable] = useState(null);
  const [sDescription, setSDescription] = useState("");
  const [fullReport, setFullReport] = useState(null);
  const [sectionPDF, setSectionPDF] = useState(null);

  const [reportPrice, setReportPrice] = useState("");

  const [status, setStatus] = useState("");
  const [fHomepage, setFHomepage] = useState(null);
  const [seoSlug, setSeoSlug] = useState("");
  const [seoTitle, setSeoTitle] = useState("");
  const [seoKeywords, setSeoKeywords] = useState("");
  const [seoDescription, setSeoDescription] = useState("");

  // ---------------- VALIDATION (AS PER YOUR LOGIC) ----------------
  const validateStep = () => {
    switch (formStep) {
      case 1:
        return (
          reportTitle &&
          subTitle &&
          industry &&
          subIndustry &&
          regions.length &&
          country.length &&
          reportType &&
          publishDate &&
          coveragePeriodFrom &&
          coveragePeriodTo
        );

      case 2:
        return reportCovers.length && reportSupports.length;

      case 3:
        if (!availableReports && !uploadedFile) return false;
        if (!samplePDF || samplePDF.type !== "application/pdf") return false;
        if (uploadedFile && uploadedFile.type !== "application/pdf") return false;
        if (image && image.type !== "image/webp") return false;
        if (charts && charts.type !== "application/pdf") return false;
        return true;

      case 4:
        if (
          !sectionName ||
          !sectionGroup ||
          !shortDescription ||
          !sDescription ||
          previewAvailable === null
        )
          return false;
        if (sectionPDF && sectionPDF.type !== "application/pdf") return false;
        return true;

      case 5:
        return true; // optional

      case 6:
        return (
          seoSlug &&
          seoTitle &&
          seoKeywords &&
          seoDescription &&
          fHomepage !== null
        );

      default:
        return true;
    }
  };

  // ---------------- PAYLOAD BUILDER ----------------
  const getPayload = () => {
    switch (formStep) {
      case 1:
        return {
          reportTitle,
          subTitle,
          industry,
          subIndustry,
          regions,
          country,
          reportType,
          publishDate,
          coveragePeriodFrom,
          coveragePeriodTo,
        };

      case 2:
        return { reportCovers, reportSupports };

      case 3: {
        const fd = new FormData();
        fd.append("availableReports", availableReports);
        if (uploadedFile) fd.append("uploadedFile", uploadedFile);
        fd.append("samplePDF", samplePDF);
        if (image) fd.append("image", image);
        if (charts) fd.append("charts", charts);
        return fd;
      }

      case 4: {
        const fd = new FormData();
        fd.append("sectionName", sectionName);
        fd.append("sectionGroup", sectionGroup);
        fd.append("shortDescription", shortDescription);
        fd.append("previewAvailable", previewAvailable);
        fd.append("sDescription", sDescription);
        fd.append("fullReport", fullReport);
        if (sectionPDF) fd.append("sectionPDF", sectionPDF);
        return fd;
      }

      case 5:
        return { reportPrice };

      case 6:
        return {
          status,
          fHomepage,
          seoSlug,
          seoTitle,
          seoKeywords,
          seoDescription,
        };

      default:
        return {};
    }
  };

  // ---------------- API CALL ----------------
  const saveStep = async (payload) => {
    const url = draftId
      ? `/api/report/step-${formStep}/${draftId}` // PUT
      : `/api/report/step-${formStep}`; // POST

    const method = draftId ? "put" : "post";

    const res = await axios({
      method,
      url,
      data: payload,
      headers: payload instanceof FormData
        ? { "Content-Type": "multipart/form-data" }
        : {},
    });

    if (!draftId && res.data?.draftId) {
      setDraftId(res.data.draftId);
    }
  };

  // ---------------- NEXT ----------------
  const handleNext = async () => {
    try {
      setError(false);

      if (!validateStep()) {
        setError(true);
        return;
      }

      const payload = getPayload();
      await saveStep(payload);

      if (formStep < totalSteps) {
        setFormStep((prev) => prev + 1);
      }
    } catch (err) {
      console.error("Next failed", err);
    }
  };

  // ---------------- SAVE DRAFT ----------------
  const handleSaveDraft = async () => {
    try {
      if (!validateStep()) {
        setError(true);
        return;
      }
      await saveStep(getPayload());
      alert("Draft saved successfully");
    } catch (err) {
      console.error("Save draft failed", err);
    }
  };

  const handlePrev = () => {
    if (formStep > 1) setFormStep((prev) => prev - 1);
  };

  // ---------------- UI ----------------
  return (
    <>
      <StepIndicator step={formStep} setStep={setFormStep} />

      {formStep === 1 && (
        <FormStep1
          reportTitle={reportTitle}
          setReportTitle={setReportTitle}
          subTitle={subTitle}
          setSubTitle={setSubTitle}
          industry={industry}
          setIndustry={setIndustry}
          subIndustry={subIndustry}
          setSubIndustry={setSubIndustry}
          regions={regions}
          setRegions={setRegions}
          country={country}
          setCountry={setCountry}
          reportType={reportType}
          setReportType={setReportType}
          publishDate={publishDate}
          setPublishDate={setPublishDate}
          coveragePeriodFrom={coveragePeriodFrom}
          setCoveragePeriodFrom={setCoveragePeriodFrom}
          coveragePeriodTo={coveragePeriodTo}
          setCoveragePeriodTo={setCoveragePeriodTo}
          error={error}
        />
      )}

      {formStep === 2 && (
        <FormStep2
          reportCovers={reportCovers}
          setReportCovers={setReportCovers}
          reportSupports={reportSupports}
          setReportSupports={setReportSupports}
          error={error}
        />
      )}

      {formStep === 3 && (
        <FormStep3
          availableReports={availableReports}
          setAvailableReports={setAvailableReports}
          uploadedFile={uploadedFile}
          setUploadedFile={setUploadedFile}
          samplePDF={samplePDF}
          setSamplePDF={setSamplePDF}
          image={image}
          setImage={setImage}
          charts={charts}
          setCharts={setCharts}
          error={error}
        />
      )}

      {formStep === 4 && (
        <FormStep4
          sectionName={sectionName}
          setSectionName={setSectionName}
          sectionGroup={sectionGroup}
          setSectionGroup={setSectionGroup}
          shortDescription={shortDescription}
          setShortDescription={setShortDescription}
          previewAvailable={previewAvailable}
          setPreviewAvailable={setPreviewAvailable}
          sDescription={sDescription}
          setSDescription={setSDescription}
          fullReport={fullReport}
          setFullReport={setFullReport}
          sectionPDF={sectionPDF}
          setSectionPDF={setSectionPDF}
          error={error}
        />
      )}

      {formStep === 5 && (
        <FormStep5
          reportPrice={reportPrice}
          setReportPrice={setReportPrice}
          error={error}
        />
      )}

      {formStep === 6 && (
        <FormStep6
          setStatus={setStatus}
          fHomepage={fHomepage}
          setFHomepage={setFHomepage}
          seoSlug={seoSlug}
          setSeoSlug={setSeoSlug}
          seoTitle={seoTitle}
          setSeoTitle={setSeoTitle}
          seoKeywords={seoKeywords}
          setSeoKeywords={setSeoKeywords}
          seoDescription={seoDescription}
          setSeoDescription={setSeoDescription}
          error={error}
        />
      )}

      {formStep === 7 && <ReviewStep />}

      <div className="flex justify-between mt-6">
        {formStep > 1 && <button onClick={handlePrev}>Back</button>}

        <div>
          <button onClick={handleSaveDraft}>Save Draft</button>
          {formStep < totalSteps ? (
            <button onClick={handleNext}>Next</button>
          ) : (
            <button>Publish</button>
          )}
        </div>
      </div>
    </>
  );
};

export default MultiStepForm;